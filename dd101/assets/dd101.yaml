---
- hosts: webservers
  become: true
  tasks: 
    - name: stop snap
      systemd:
        name: snapd.service
        state: stopped
        enabled: no
        
    - name: stop auto updates
      shell: systemctl stop apt-daily.timer;systemctl disable apt-daily.timer;systemctl disable apt-daily.service;systemctl stop apt-daily-upgrade.timer;systemctl disable apt-daily-upgrade.timer;systemctl disable apt-daily-upgrade.service
    - name: num 2
      service:
        name: unattended-upgrades
        state: stopped
    - name: aashtast
      file:
        path: /var/lib/apt/lists/lock
        state: absent
    - name: aashtast
      file:
        path: /var/cache/apt/archives/lock
        state: absent
    - name: aashtast
      file:
        path: /var/lib/dpkg/lock
        state: absent
    # - name: ahasht
    #   shell: dpkg --configure -a

    - name: kill apt
      shell: killall apt apt-get 2>/dev/null
      ignore_errors: yes
    - name: update apt
      action: apt update_cache=true


    # - name: Wait for automatic system updates
    #   shell: while pgrep unattended; do sleep 2; done;

- hosts: webservers
  roles:
    - { role: Datadog.datadog, become: yes }
  vars:
    datadog_api_key: "{{ lookup('env', 'DD_API_KEY')}}"
     

- hosts: webservers
  remote_user: root
  tasks:
    - name: install apache
      apt:
        name: apache2
    